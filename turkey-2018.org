* Turkey 2018 elections

data from [[https://gist.github.com/oztalha/0bdaa68e53466f64055ad276f11e868e][presidential]] and [[https://gist.github.com/oztalha/63f2de239bac84f4f81e86442d1a0749][parliament]] ([[https://twitter.com/tozCSS/status/1011004328549597186][Oz Talha]]).  [[https://www.yenisafak.com/secim-cumhurbaskanligi-2018][YeniŞafak]] (and,
YeniŞafak's [[results page]], which includes data also on past elections).
unfortunately, all this is by ilce.  well, e.g., [[https://www.yenisafak.com/secim-2018/yalova-ili-secim-sonuclari][Yalova ili results]]
have quantities.

to look at what beautify finds:
#+BEGIN_SRC python :var city="adana" :var fname="test"
  import codecs
  import requests
  import pandas as pd
  from bs4 import BeautifulSoup
  from unidecode import unidecode

  print(city)
  url = 'https://www.yenisafak.com/secim-2018/'+unidecode(city).lower()+'-ili-secim-sonuclari'
  resource = requests.get(url)
  soup = BeautifulSoup(resource.content.decode('utf-8','ignore'), "html5lib")
  fi = codecs.open(fname, "w", "utf-8")
  print >>fi, soup.prettify()
  fi.close()
#+END_SRC

#+RESULTS:
: None

#+name: secim-2018-genel-scraper
#+BEGIN_SRC python :var fname="test" :session ss
  import codecs
  import requests
  import pandas as pd
  from bs4 import BeautifulSoup
  from unidecode import unidecode

  city_meta = 'https://raw.githubusercontent.com/oztalha/2015-11-01-Elections-Turkey/master/data/city_meta.csv'
  cities = pd.read_csv(city_meta,usecols=['il'], encoding='utf-8').il #Cities w/ Turkish characters

  results = {}
  attnames = []
  pnames = []
  for c in cities:
      print(c)
      url = 'https://www.yenisafak.com/secim-2018/'+unidecode(c).lower()+'-ili-secim-sonuclari'
      resource = requests.get(url)
      soup = BeautifulSoup(resource.content.decode('utf-8','ignore'), "html5lib")
      # kill all script, style, sub, sup and b elements
      for script in soup(["script", "style", "sup", "sub", "b"]):
          null = script.extract()    # rip it out
      # now, find voting percentages, number of ballot boxes
      attendance = soup.find_all(class_='attendance')
      if len(attendance) != 1:
          print "len(attendance) = %d too big (> 1)" % (len(attendance))
          # raise AssertionError   # XXX
      attendance = attendance[0]
      names = [i.text for i in attendance.find_all(class_='name')]
      data = [i.text.replace('.','') for i in attendance.find_all(class_='data')]
      if len(names) != len(data):
          print "len(names) = %d != len(data) = %d" % (len(names, len(data)))
          raise AssertionError
      if attnames != [] and attnames != names:
          print "attnames (= [%s]) != names (= [%s])" % (attnames, names)
          raise AssertionError    # make sure in *same* order each time
      attnames = names
      attdata = data
      # now, where are the votes?
      # (XXX need to do i.select to get *each* of the cards?)
      where = [j for i in soup.select('.card') for j in i.select('table:nth-of-type(1)')]
      names = [j.text for i in where for j in i.select('.names .bars-text')]
      pmps = [int(j.text) for i in where for j in i.select('.mps .bars-text')]
      pvotes = [int(j.text.split(" ")[1].replace('.','')) for i in where for j in i.select('.ratio-back .bars-votes')]
      if len(names) != len(pmps) or len(names) != len(pvotes):
          print "len(names) (= %d) != len(pmps) (= %d) or len(pvotes) (= %d)" % (len(names), len(pmps), len(pvotes))
          raise AssertionError    # if we have different length of parties, MPs, votes
      if pnames == []:
          pnames = names          # remember party names
      results[c] = attdata + pvotes + pmps

  genel = pd.DataFrame({(city):result for city,result in results.items()}, index=attnames + pnames + map(lambda x: x + " MPs", pnames)).T
  genel.index.names = ['city']
  genel.to_csv(fname, encoding="utf-8")
#+END_SRC

#+RESULTS:

#+BEGIN_SRC R :session rs :var ifile="test" :results table :colnames yes :rownames yes
  x <- read.csv(ifile)
  parties <- colnames(x)[-(1:5)]
  parties <- parties[1:(length(parties)/2)]
  mps <- colnames(x)[-(1:5)]
  mps <- mps[-(1:length(parties))]
  res <- data.frame()
  total.votes <- sum(x[,parties])
  total.mps <- sum(x[,mps])
  res <- data.frame()
  for (party in parties) {
      votes <- sum(x[,party])
      mps <- sum(x[,paste(party, "MPs", sep=".")])
      df <- data.frame(votes=votes, pctvotes=votes/total.votes,
                       mps=mps, pctmps=mps/total.mps)
      rownames(df) <- party
      res <- rbind(res, df)
  }
  res
#+END_SRC

#+RESULTS:
|           |    votes |             pctvotes | mps |             pctmps |
|-----------+----------+----------------------+-----+--------------------|
| AK.Parti  | 23029074 |     0.45942923148743 | 327 |              0.545 |
| CHP       | 12377764 |    0.246935964600781 | 158 |  0.263333333333333 |
| HDP       |  6383514 |    0.127350883982971 |  62 |  0.103333333333333 |
| İYİ.Parti |  4619952 |   0.0921678829495625 |  35 | 0.0583333333333333 |
| MHP       |  2750810 |   0.0548785645600833 |  18 |               0.03 |
| SP        |   668209 |   0.0133307464878086 |   0 |                  0 |
| HÜDA.PAR  |   180347 |  0.00359791642560458 |   0 |                  0 |
| VP        |    96462 |  0.00192441357076452 |   0 |                  0 |
| Bağımsız  |    19268 | 0.000384395934995032 |   0 |                  0 |
| Diğer     |        0 |                    0 |   0 |                  0 |
